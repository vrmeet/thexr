const fs = require('fs')
const { couldStartTrivia } = require('typescript')

const sourceFilePath = './js/event-names.ts'
const targetFilePath = "../lib/event_name.ex"

fs.watch(sourceFilePath, () => {
    console.log('file changed')
    fs.readFile(sourceFilePath, 'utf8', (err, data) => {
        if (err) {
            console.error(err);
            return;
        }
        // just the data between { and } of the 'enum'
        const events = data.substring(
            data.indexOf("{") + 1,
            data.lastIndexOf("}")
        ).split(',')
            .map(event => {
                return event.replace(/[^a-z_]/g, '')
            })

        const functions = events.reduce((acc, event, index) => {
            acc.int_to_atoms.push(`  def int_to_atom(${index + 1}), do: :${event}`)
            acc.atom_to_ints.push(`  def atom_to_int(:${event}), do: ${index + 1}`)
            return acc
        }, { int_to_atoms: [], atom_to_ints: [] })

        let newContent = `
# UPDATE event-names.ts INSTEAD OF THIS FILE
# THIS FILE IS AUTOGENERATED, DO NOT MANUALLY UPDATE
#
defmodule EventName do

${functions.int_to_atoms.join("\n")}

${functions.atom_to_ints.join("\n")}

end
        `
        console.log(newContent)
        fs.writeFileSync(targetFilePath, newContent, { mode: 0o644 })
    });


})